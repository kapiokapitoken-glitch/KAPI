<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>KAPI RUN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="KAPI RUN Game" />
  <meta name="author" content="Okapi Team" />

  <!-- Manifest & iconlar -->
  <link rel="manifest" href="./appmanifest.json?v=20250917zz" />
  <link rel="apple-touch-icon" sizes="128x128" href="./icons/icon-128.png" />
  <link rel="apple-touch-icon" sizes="256x256" href="./icons/icon-256.png" />
  <link rel="icon" type="image/png" href="./icons/icon-256.png" />
  <link rel="stylesheet" href="./style.css?v=20250917zz" />

  <style>
    /* Masaüstünde gösterilecek uyarı için basit stil */
    #deviceBlock{
      display:none; position:fixed; inset:0; background:#0b0b0b; color:#fff;
      align-items:center; justify-content:center; text-align:center; padding:24px; z-index:99999;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #deviceBlock .card{
      max-width:520px; background:#151515; border:1px solid #2a2a2a; border-radius:12px; padding:20px;
    }
    #deviceBlock h2{ margin:0 0 8px; font-size:22px; }
    #deviceBlock p { margin:6px 0; opacity:.9 }
    #deviceBlock a { color:#4ea2ff; text-decoration:none }
    .hide { display:none!important }
  </style>
</head>
<body>
  <div id="fb-root"></div>

  <noscript>
    <div id="notSupportedWrap">
      <h2>Bu içerik JavaScript gerektirir</h2>
      <p class="notSupportedMessage">Devam etmek için JavaScript’i etkinleştirin.</p>
    </div>
  </noscript>

  <!-- Masaüstü/uygunsuz ortam uyarısı -->
  <div id="deviceBlock">
    <div class="card">
      <h2>Mobilde Oynayın</h2>
      <p>Bu oyun Telegram uygulaması içinde <b>iOS</b> veya <b>Android</b> cihazlarda çalışır.</p>
      <p>Telegram’ın <b>mobil</b> uygulamasından botun menüsündeki <b>KAPI RUN</b> düğmesine dokunun.</p>
      <p style="opacity:.8; font-size:13px; margin-top:10px">
        (Masaüstü/Browser’dan açtığınız için oyun yüklenmedi.)
      </p>
    </div>
  </div>

  <!-- iOS: ilk dokunuşta AudioContext kilidini aç -->
  <script>
    document.addEventListener("touchstart", function () {
      try {
        var Ctx = window.AudioContext || window.webkitAudioContext;
        if (Ctx) {
          var ctx = new Ctx();
          if (ctx.state === "suspended" && ctx.resume) ctx.resume();
        }
      } catch (e) {}
    }, { once: true });
  </script>

  <!-- Geliştirme sırasında SW ve cache'i kapat (üretimde istersen kaldır) -->
  <script>
    (function () {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.getRegistrations()
          .then(rs => rs.forEach(r => r.unregister()))
          .catch(() => {});
      }
      if (window.caches && caches.keys) {
        caches.keys().then(keys => Promise.all(keys.map(k => caches.delete(k)))).catch(() => {});
      }
    })();
  </script>

  <!-- C3 ayarları -->
  <script>
    (function(){
      const V = "20250917zz";                  // versiyon etiketi
      window.C3_NO_WORKER = true;
      window.C3_IsSupported = true;
      window.C3_ProjectDataUrl = "data.json?v=" + V;
      window["C3_ProjectDataUrl"] = "data.json?v=" + V;
      window.__KAPI_VERSION__ = V;             // istersen başka yerlerde kullan
    })();
  </script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Skor köprüsü (submitScore) -->
  <script src="./scripts/tg-bridge.js?v=20250917zz"></script>

  <!-- Mobil/Telegram kontrolü ve koşullu C3 yükleme -->
  <script>
    (function(){
      const V = window.__KAPI_VERSION__ || "20250917zz";
      const TG = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

      function allowRun(){
        if (!TG) return false;                             // Telegram WebApp dışında açılmış
        const p = (TG.platform || "").toLowerCase();       // 'ios' | 'android' | 'tdesktop' | 'macos' | 'web'
        return p === "ios" || p === "android";
      }

      function loadC3(){
        const s = document.createElement("script");
        s.type = "module";
        s.crossOrigin = "anonymous";
        s.src = "./scripts/main.js?v=" + V;
        document.body.appendChild(s);
      }

      function showBlock(){
        const el = document.getElementById("deviceBlock");
        if (el) el.style.display = "flex";
      }

      try { if (TG) TG.ready(); } catch(e){}

      if (allowRun()) {
        loadC3();
      } else {
        showBlock();
      }
    })();
  </script>
</body>
</html>
