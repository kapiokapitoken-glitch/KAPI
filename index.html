<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KAPI RUN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="KAPI RUN Game" />
  <meta name="author" content="Okapi Team" />

  <!-- Manifest & icons -->
  <link rel="manifest" href="./appmanifest.json?v=20250917zz" />
  <link rel="apple-touch-icon" sizes="128x128" href="./icons/icon-128.png" />
  <link rel="apple-touch-icon" sizes="256x256" href="./icons/icon-256.png" />
  <link rel="icon" type="image/png" href="./icons/icon-256.png" />
  <link rel="stylesheet" href="./style.css?v=20250917zz" />

  <style>
    /* Simple style for desktop warning */
    #deviceBlock{
      display:none; position:fixed; inset:0; background:#0b0b0b; color:#fff;
      align-items:center; justify-content:center; text-align:center; padding:24px; z-index:99999;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #deviceBlock .card{
      max-width:520px; background:#151515; border:1px solid #2a2a2a; border-radius:12px; padding:20px;
    }
    #deviceBlock h2{ margin:0 0 8px; font-size:22px; }
    #deviceBlock p { margin:6px 0; opacity:.9 }
    #deviceBlock a { color:#4ea2ff; text-decoration:none }
    .hide { display:none!important }
  </style>
</head>
<body>
  <div id="fb-root"></div>

  <noscript>
    <div id="notSupportedWrap">
      <h2>This content requires JavaScript</h2>
      <p class="notSupportedMessage">Please enable JavaScript to continue.</p>
    </div>
  </noscript>

  <!-- Desktop/unsupported environment warning -->
  <div id="deviceBlock">
    <div class="card">
      <h2>Play on Mobile</h2>
      <p>This game works only inside the Telegram app on <b>iOS</b> or <b>Android</b> devices.</p>
      <p>Open Telegram on your <b>mobile</b> and tap the <b>KAPI RUN</b> button in the bot menu to start.</p>
      <p style="opacity:.8; font-size:13px; margin-top:10px">
        (Not available when opened from desktop/browser.)
      </p>
    </div>
  </div>

  <!-- iOS: unlock AudioContext on first touch -->
  <script>
    document.addEventListener("touchstart", function () {
      try {
        var Ctx = window.AudioContext || window.webkitAudioContext;
        if (Ctx) {
          var ctx = new Ctx();
          if (ctx.state === "suspended" && ctx.resume) ctx.resume();
        }
      } catch (e) {}
    }, { once: true });
  </script>

  <!-- During development, disable SW and cache (remove in production if desired) -->
  <script>
    (function () {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.getRegistrations()
          .then(rs => rs.forEach(r => r.unregister()))
          .catch(() => {});
      }
      if (window.caches && caches.keys) {
        caches.keys().then(keys => Promise.all(keys.map(k => caches.delete(k)))).catch(() => {});
      }
    })();
  </script>

  <!-- C3 settings -->
  <script>
    (function(){
      const V = "20250917zz";                  // version tag
      window.C3_NO_WORKER = true;
      window.C3_IsSupported = true;
      window.C3_ProjectDataUrl = "data.json?v=" + V;
      window["C3_ProjectDataUrl"] = "data.json?v=" + V;
      window.__KAPI_VERSION__ = V;             // custom version marker
    })();
  </script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Score bridge (submitScore) -->
  <script src="./scripts/tg-bridge.js?v=20250917zz"></script>

  <!-- Mobile/Telegram check and conditional C3 loading -->
  <script>
    (function(){
      const V = window.__KAPI_VERSION__ || "20250917zz";
      const TG = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

      function allowRun(){
        if (!TG) return false;                             // Opened outside Telegram WebApp
        const p = (TG.platform || "").toLowerCase();       // 'ios' | 'android' | 'tdesktop' | 'macos' | 'web'
        return p === "ios" || p === "android";
      }

      function loadC3(){
        const s = document.createElement("script");
        s.type = "module";
        s.crossOrigin = "anonymous";
        s.src = "./scripts/main.js?v=" + V;
        document.body.appendChild(s);
      }

      function showBlock(){
        const el = document.getElementById("deviceBlock");
        if (el) el.style.display = "flex";
      }

      try { if (TG) TG.ready(); } catch(e){}

      if (allowRun()) {
        loadC3();
      } else {
        showBlock();
      }
    })();
  </script>
</body>
</html>
