<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>WA Self-Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:16px}
.ok{color:#0a0;font-weight:700}.bad{color:#b00;font-weight:700}
button{padding:8px 12px;margin-right:8px;margin-top:8px}
textarea{width:100%;height:140px;font-family:ui-monospace,Consolas,monospace}
pre{background:#111;color:#0f0;padding:10px;overflow:auto;white-space:pre-wrap}
</style>
</head>
<body>
<h2>Telegram WebApp Self-Test</h2>
<div id="env">Kontrol ediliyor…</div>
<div>
  <button id="btnCopy">Copy initData</button>
  <button id="btnCtx">CTX</button>
  <button id="btnSend">Send 123</button>
</div>
<h3>initData</h3>
<textarea id="ta"></textarea>
<h3>Parsed</h3>
<pre id="parsed"></pre>
<h3>Log</h3>
<pre id="log"></pre>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
(function(){
  const logEl = document.getElementById('log');
  const log = (...a)=>{ logEl.textContent += a.join(' ')+'\\n'; logEl.scrollTop = logEl.scrollHeight; };

  const TG = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  const isTG = !!TG, platform = isTG ? TG.platform : 'n/a', version = isTG ? TG.version : 'n/a';
  document.getElementById('env').innerHTML =
    'Telegram.WebApp: ' + (isTG?'<span class="ok">PRESENT</span>':'<span class="bad">ABSENT</span>') +
    ' | platform: <b>'+platform+'</b> | version: <b>'+version+'</b>';

  function qsFromUnsafe(u){
    if(!u) return "";
    const pairs=[]; const push=(k,v)=>{ if(v!==undefined && v!==null && v!=="") pairs.push([k,String(v)]) };
    if(u.user){ try{ push("user", JSON.stringify(u.user)); }catch(e){} }
    push("chat_instance",u.chat_instance);
    push("chat_type",(u.chat&&u.chat.type)||u.chat_type);
    push("query_id",u.query_id);
    push("start_param",u.start_param);
    push("can_send_after",u.can_send_after);
    push("auth_date",u.auth_date);
    push("hash",u.hash);
    pairs.sort((a,b)=>a[0].localeCompare(b[0]));
    const usp=new URLSearchParams(); pairs.forEach(([k,v])=>usp.append(k,v));
    return usp.toString();
  }

  // initData: önce TG.initData, yoksa unsafe'ten üret
  let init=""; let unsafe=null;
  try{ unsafe = isTG ? TG.initDataUnsafe : null; init = (isTG&&TG.initData) || qsFromUnsafe(unsafe) || ""; }catch(e){ log('ERR initData:', e) }
  const ta = document.getElementById('ta'); ta.value = init;

  // parse
  try{
    const p=new URLSearchParams(init); const obj={};
    for(const [k,v] of p.entries()) obj[k]=v;
    if(obj.user){ try{ obj.user=JSON.parse(obj.user); }catch(e){} }
    document.getElementById('parsed').textContent = JSON.stringify(obj,null,2);
  }catch(e){ document.getElementById('parsed').textContent=String(e) }

  document.getElementById('btnCopy').onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(ta.value||"");
      log('Copied: len=', (ta.value||"").length, ' hasHash=', /(?:^|&)hash=/.test(ta.value||""));
    }catch(e){ log('Clipboard error:', e) }
  };

  document.getElementById('btnCtx').onclick = ()=>{
    try{
      log('CTX init_len=', (ta.value||"").length, ' hasHash=', /(?:^|&)hash=/.test(ta.value||""));
    }catch(e){ log('CTX err:', e) }
  };

  document.getElementById('btnSend').onclick = async ()=>{
    try{
      const initData = ta.value || '';
      const params = new URLSearchParams(initData);
      let user_id=null, username=null, hash=null;
      const userStr=params.get('user');
      if(userStr){ try{ const u=JSON.parse(userStr); user_id=u&&u.id||null; username=u&&u.username||null; }catch(e){} }
      hash = params.get('hash');
      const payload = {
        score: 123,
        user_id, username,
        sig: hash,
        init_data: initData
      };
      log('POST /api/score payload:', JSON.stringify({
        score: payload.score,
        user_id, username,
        sig_len: hash?hash.length:0,
        init_len: initData.length
      }));
      const r = await fetch('/api/score', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-Telegram-Init-Data': initData },
        body: JSON.stringify(payload)
      });
      const t = await r.text();
      log('RESP', r.status, t);
    }catch(e){ log('SEND err:', e) }
  };

  if(TG){ try{ TG.ready(); }catch(e){} }
})();
</script>
</body>
</html>
