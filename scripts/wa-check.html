<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>WA Self-Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:16px}
.ok{color:#0a0;font-weight:700}.bad{color:#b00;font-weight:700}
textarea{width:100%;height:140px;font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
button{padding:8px 12px;margin-right:8px;margin-top:8px}
pre{background:#111;color:#0f0;padding:10px;overflow:auto}
</style>
</head>
<body>
<h2>Telegram WebApp Self-Test (/scripts/wa-check.html)</h2>
<div id="env"></div>
<div>
  <button id="btnInit">INIT</button>
  <button id="btnCopy">Copy initData</button>
  <button id="btnSend">Send 123</button>
  <button id="btnProbe">Probe C3 assets</button>
</div>
<h3>initData</h3>
<textarea id="ta"></textarea>
<h3>Parsed</h3>
<pre id="parsed"></pre>
<h3>Logs</h3>
<pre id="log"></pre>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
(function(){
  const logEl = document.getElementById('log');
  const log = (...a)=>{ logEl.textContent += a.join(' ')+'\\n'; logEl.scrollTop = logEl.scrollHeight; };

  const TG = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (TG) { try { TG.ready(); } catch(e) { log('ready() err',e) } }

  const isTG = !!TG, platform = isTG?TG.platform:'n/a', version=isTG?TG.version:'n/a';
  document.getElementById('env').innerHTML =
    'Telegram.WebApp: ' + (isTG?'<span class="ok">PRESENT</span>':'<span class="bad">ABSENT</span>')+
    ' | platform: <b>'+platform+'</b> | version: <b>'+version+'</b>';

  const ta=document.getElementById('ta');

  function readInit(){
    let init = "";
    let src  = "none";
    try{
      if (isTG && TG.initData && TG.initData.length > 0) {
        init = TG.initData;              // <-- sadece gerçek initData
        src  = "initData";
      } else {
        init = ""; src = "none";
      }
    }catch(e){ log('ERR initData:',e); }

    ta.value = init;

    // parsed
    try{
      const p=new URLSearchParams(init); const obj={};
      for(const [k,v] of p.entries()) obj[k]=v;
      if(obj.user){ try{ obj.user=JSON.parse(obj.user); }catch(e){} }
      document.getElementById('parsed').textContent=JSON.stringify(obj,null,2);
    }catch(e){ document.getElementById('parsed').textContent=String(e); }

    log('INIT src=',src,' len=', (init||"").length, ' hasHash=', /(^|&)hash=/.test(init||""));
  }

  // ilk okuma + küçük gecikmeyle tekrar
  readInit();
  setTimeout(readInit, 150);

  document.getElementById('btnInit').onclick = readInit;

  document.getElementById('btnCopy').onclick = async ()=>{
    try{
      const v = ta.value||"";
      await navigator.clipboard.writeText(v);
      log('Copied initData len=',v.length,' hasHash=',/(^|&)hash=/.test(v));
    }catch(e){ log('Clipboard error:',e); }
  };

  document.getElementById('btnSend').onclick = async ()=>{
    try{
      const initData = ta.value || '';
      if (!/(^|&)hash=/.test(initData)) {
        log('SEND ABORT: TG.initData yok (WebApp olarak açılmadı).');
        return;
      }
      const params = new URLSearchParams(initData);
      let user_id=null, username=null, hash=null;
      const userStr=params.get('user');
      if(userStr){ try{ const u=JSON.parse(userStr); user_id=u&&u.id||null; username=u&&u.username||null; }catch(e){} }
      hash=params.get('hash');

      const payload = { score:123, user_id, username, sig_len:(hash?hash.length:0), init_len:initData.length };
      log('POST /api/score payload:', JSON.stringify(payload));

      const res = await fetch('/api/score', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-Telegram-Init-Data': initData },
        body: JSON.stringify({ score: 123, init_data: initData }),
        credentials:'include'
      });
      const txt = await res.text();
      log('RESP', res.status, txt);
    }catch(e){ log('SEND err', e); }
  };

  document.getElementById('btnProbe').onclick = async ()=>{
    async function probe(u){
      try{
        const r = await fetch(u, { cache:'no-store' });
        log('PROBE', u, '->', r.status);
      }catch(e){ log('PROBE', u, 'err', e); }
    }
    await probe('./scripts/main.js?v=20250917zz');
    await probe('./data.json?v=20250917zz');
  };
})();
</script>
</body>
</html>
